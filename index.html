<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NearBonds - Find Your Tribe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1a202c;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 1rem;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
        }
        .chat-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #e2e8f0;
            border-radius: 0.5rem;
        }
        .chat-message {
            background-color: #cbd5e1;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .my-message {
            background-color: #a3c1f1;
            text-align: right;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center">

    <div class="container py-8">
        <!-- Header Section -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-blue-800">NearBonds</h1>
            <p class="mt-2 text-gray-600">Find and join your local community.</p>
            <div id="userIdDisplay" class="mt-4 p-2 text-xs bg-gray-200 text-gray-700 rounded-md break-words">
                Loading user...
            </div>
            <div class="mt-4">
                <button onclick="openProfileModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-full transition duration-200">
                    My Profile
                </button>
            </div>
        </div>

        <!-- Toggle between All and My Hangouts -->
        <div class="flex justify-center mb-6 space-x-4">
            <button id="showAllHangoutsBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-200">
                All Hangouts
            </button>
            <button id="showMyHangoutsBtn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-full transition duration-200">
                My Hangouts
            </button>
        </div>

        <!-- Create Hangout Button -->
        <div class="text-center mb-6">
            <button onclick="openCreateModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-200">
                Create a New Hangout
            </button>
        </div>

        <!-- Hangouts List -->
        <div id="hangoutsContainer" class="space-y-4">
            <!-- Hangout cards will be dynamically inserted here -->
            <div id="loading" class="text-center text-gray-500">Loading hangouts...</div>
        </div>

        <!-- No Hangouts Message -->
        <div id="noHangoutsMessage" class="hidden text-center text-gray-500 mt-8">
            <p>No hangouts found. Be the first to create one!</p>
        </div>
    </div>

    <!-- Create Hangout Modal -->
    <div id="createModal" class="modal-overlay">
        <div class="modal text-center relative">
            <button onclick="closeModal('createModal')" class="absolute top-4 right-4 text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            <h3 class="text-2xl font-bold text-blue-800 mb-4">Create a New Hangout</h3>
            <form id="createHangoutForm">
                <select id="hangoutName" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                    <option value="" disabled selected>Select a hangout type</option>
                    <option value="Evening Chai Circle">Evening Chai Circle</option>
                    <option value="Board Game & Chill">Board Game & Chill</option>
                    <option value="Pet + Coffee Meetups">Pet + Coffee Meetups</option>
                    <option value="More coming soon" disabled>More coming soon</option>
                </select>
                <input type="number" id="participantCount" min="3" max="6" placeholder="Number of participants (3-6)" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <input type="text" id="hangoutLocation" placeholder="Location (e.g., Cubbon Park)" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <input type="date" id="hangoutDate" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <input type="time" id="hangoutTime" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <textarea id="hangoutDescription" rows="3" placeholder="Write a fun description..." class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"></textarea>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-200">
                    Create Hangout
                </button>
            </form>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal text-center relative">
            <button onclick="closeModal('profileModal')" class="absolute top-4 right-4 text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            <h3 class="text-2xl font-bold text-blue-800 mb-4">My Profile</h3>
            <form id="profileForm">
                <input type="text" id="nicknameInput" placeholder="Enter your nickname" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-200">
                    Save Profile
                </button>
            </form>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="modal-overlay">
        <div class="chat-modal-content relative">
            <button onclick="closeModal('chatModal')" class="absolute top-4 right-4 text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            <h3 id="chatTitle" class="text-2xl font-bold text-blue-800 mb-4"></h3>
            <div id="chatMessages" class="chat-messages mb-4"></div>
            <form id="chatForm">
                <input type="text" id="chatMessageInput" placeholder="Type a message..." required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-200">
                    Send
                </button>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal-overlay">
        <div class="modal text-center relative">
            <h3 class="text-2xl font-bold text-blue-800 mb-4">Delete Hangout?</h3>
            <p class="text-gray-600 mb-4">Are you sure you want to delete this hangout? This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-200">
                    Cancel
                </button>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, arrayUnion, arrayRemove, addDoc, serverTimestamp, getDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBfcdj83TJxGPdZdVG5pRpP8lw0P1SIhY8",
            authDomain: "nearbonds.firebaseapp.com",
            projectId: "nearbonds",
            storageBucket: "nearbonds.firebasestorage.app",
            messagingSenderId: "1053786657821",
            appId: "1:1053786657821:web:6725758a48d4e4251322f4"
        };
        
        let db, auth, userId, userNickname = 'Guest';
        let currentHangoutsUnsubscribe;

        // --- UI Elements ---
        const userIdDisplay = document.getElementById('userIdDisplay');
        const hangoutsContainer = document.getElementById('hangoutsContainer');
        const loadingSpinner = document.getElementById('loading');
        const noHangoutsMessage = document.getElementById('noHangoutsMessage');
        const createModal = document.getElementById('createModal');
        const profileModal = document.getElementById('profileModal');
        const chatModal = document.getElementById('chatModal');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const createHangoutForm = document.getElementById('createHangoutForm');
        const profileForm = document.getElementById('profileForm');
        const hangoutNameInput = document.getElementById('hangoutName');
        const participantCountInput = document.getElementById('participantCount');
        const hangoutDescriptionInput = document.getElementById('hangoutDescription');
        const hangoutLocationInput = document.getElementById('hangoutLocation');
        const hangoutDateInput = document.getElementById('hangoutDate');
        const hangoutTimeInput = document.getElementById('hangoutTime');
        const nicknameInput = document.getElementById('nicknameInput');
        const chatTitle = document.getElementById('chatTitle');
        const chatMessagesDiv = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const chatMessageInput = document.getElementById('chatMessageInput');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const showAllHangoutsBtn = document.getElementById('showAllHangoutsBtn');
        const showMyHangoutsBtn = document.getElementById('showMyHangoutsBtn');

        let currentChatUnsubscribe;
        let hangoutToDeleteId = null;

        // --- Firebase Initialization and Authentication ---
        function initFirebaseAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await fetchUserProfile();
                        // Start with all hangouts visible
                        listenForHangouts(false); 
                    } else {
                        // Attempt anonymous sign-in
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Authentication failed. Please check Firebase config and Anonymous Auth settings.", error);
                            userIdDisplay.textContent = 'Auth failed. See console for details.';
                            loadingSpinner.classList.add('hidden');
                        }
                    }
                });
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                userIdDisplay.textContent = 'Initialization failed. Check your Firebase config.';
                loadingSpinner.classList.add('hidden');
            }
        }
        
        initFirebaseAndAuth();

        async function fetchUserProfile() {
            try {
                const profileDocRef = doc(db, `artifacts/${firebaseConfig.appId}/public/data/profiles`, userId);
                const profileSnap = await getDoc(profileDocRef);
                if (profileSnap.exists()) {
                    userNickname = profileSnap.data().nickname;
                    userIdDisplay.textContent = `Welcome, ${userNickname}!`;
                } else {
                    userNickname = userId.substring(0, 8);
                    userIdDisplay.textContent = `Welcome, ${userNickname}! Your User ID: ${userId}`;
                }
            } catch (e) {
                console.error("Error fetching user profile:", e);
                userNickname = userId.substring(0, 8);
                userIdDisplay.textContent = `Welcome, ${userNickname}! Your User ID: ${userId}`;
            }
        }

        // --- Modal Functions ---
        window.openCreateModal = function() {
            createModal.style.display = 'flex';
        }

        window.openProfileModal = function() {
            nicknameInput.value = userNickname !== userId.substring(0,8) ? userNickname : '';
            profileModal.style.display = 'flex';
        }

        window.openChatModal = function(hangout) {
            if (currentChatUnsubscribe) {
                currentChatUnsubscribe();
            }
            chatTitle.textContent = hangout.name;
            chatMessagesDiv.innerHTML = '';
            chatModal.style.display = 'flex';
            
            const chatCollection = collection(db, `artifacts/${firebaseConfig.appId}/public/data/hangouts/${hangout.id}/chat`);
            currentChatUnsubscribe = onSnapshot(chatCollection, (snapshot) => {
                chatMessagesDiv.innerHTML = '';
                snapshot.docs.forEach(doc => {
                    const message = doc.data();
                    const messageSender = message.nickname || message.userId.substring(0, 8);
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-message ${message.userId === userId ? 'bg-blue-300 ml-auto' : 'bg-gray-300'} p-2 rounded-lg mb-2 max-w-[80%]`;
                    messageDiv.innerHTML = `<span class="font-bold text-xs">${message.userId === userId ? 'You' : messageSender}:</span><br>${message.text}`;
                    chatMessagesDiv.appendChild(messageDiv);
                });
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
            }, (error) => {
                console.error("Error listening to chat messages:", error);
            });

            chatForm.onsubmit = async (event) => {
                event.preventDefault();
                const text = chatMessageInput.value.trim();
                if (!text) return;
                
                try {
                    await addDoc(chatCollection, {
                        userId: userId,
                        nickname: userNickname,
                        text: text,
                        timestamp: serverTimestamp()
                    });
                    chatMessageInput.value = '';
                } catch (e) {
                    console.error("Error sending message: ", e);
                }
            };
        }

        window.openDeleteConfirmModal = function(hangoutId) {
            hangoutToDeleteId = hangoutId;
            deleteConfirmModal.style.display = 'flex';
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (currentChatUnsubscribe) {
                currentChatUnsubscribe();
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == createModal) closeModal('createModal');
            if (event.target == profileModal) closeModal('profileModal');
            if (event.target == chatModal) closeModal('chatModal');
            if (event.target == deleteConfirmModal) closeModal('deleteConfirmModal');
        }

        // --- Firestore Real-time Listener ---
        function listenForHangouts(showMyHangouts) {
            if (currentHangoutsUnsubscribe) {
                currentHangoutsUnsubscribe();
            }
            const hangoutsCollection = collection(db, `artifacts/${firebaseConfig.appId}/public/data/hangouts`);
            let q;
            if (showMyHangouts) {
                q = query(hangoutsCollection, where("members", "array-contains", userId));
            } else {
                q = hangoutsCollection;
            }

            currentHangoutsUnsubscribe = onSnapshot(q, async (snapshot) => {
                hangoutsContainer.innerHTML = '';
                loadingSpinner.classList.add('hidden');
                const hangouts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Fetch host nicknames, but only if hostId exists
                const profilePromises = hangouts.map(h => {
                    if (h.hostId) {
                        return getDoc(doc(db, `artifacts/${firebaseConfig.appId}/public/data/profiles`, h.hostId));
                    }
                    return Promise.resolve(null);
                });
                const profileSnapshots = await Promise.all(profilePromises);
                
                const hangoutsWithHosts = hangouts.map((hangout, index) => {
                    const hostProfile = profileSnapshots[index] ? profileSnapshots[index].data() : null;
                    return {
                        ...hangout,
                        hostNickname: hostProfile ? hostProfile.nickname : 'Unknown'
                    };
                });

                if (hangoutsWithHosts.length === 0) {
                    noHangoutsMessage.classList.remove('hidden');
                } else {
                    noHangoutsMessage.classList.add('hidden');
                    hangoutsWithHosts.forEach(hangout => {
                        const card = createHangoutCard(hangout);
                        hangoutsContainer.appendChild(card);
                    });
                }
            }, (error) => {
                console.error("Error listening to hangouts:", error);
                loadingSpinner.textContent = 'Error loading hangouts.';
            });
        }
        
        showAllHangoutsBtn.onclick = () => {
            showAllHangoutsBtn.classList.add('bg-blue-600', 'text-white');
            showAllHangoutsBtn.classList.remove('bg-gray-300', 'text-gray-800');
            showMyHangoutsBtn.classList.add('bg-gray-300', 'text-gray-800');
            showMyHangoutsBtn.classList.remove('bg-blue-600', 'text-white');
            listenForHangouts(false);
        };
        
        showMyHangoutsBtn.onclick = () => {
            showMyHangoutsBtn.classList.add('bg-blue-600', 'text-white');
            showMyHangoutsBtn.classList.remove('bg-gray-300', 'text-gray-800');
            showAllHangoutsBtn.classList.add('bg-gray-300', 'text-gray-800');
            showAllHangoutsBtn.classList.remove('bg-blue-600', 'text-white');
            listenForHangouts(true);
        };


        // --- UI Rendering Functions ---
        function createHangoutCard(hangout) {
            const card = document.createElement('div');
            card.className = 'card p-6 flex flex-col md:flex-row md:items-center justify-between';
            
            const membersCount = hangout.members ? hangout.members.length : 0;
            const isMember = hangout.members && hangout.members.includes(userId);
            const isFull = membersCount >= hangout.maxParticipants;
            const isHost = hangout.hostId === userId;
            
            const chatButton = isMember ? 
                `<button onclick="openChatModal(${JSON.stringify(hangout).replace(/"/g, '&quot;')})" 
                         class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-200 ml-4">
                    Chat
                </button>` : '';

            const joinButton = !isMember && !isFull ? 
                `<button onclick="joinHangout('${hangout.id}')" class="mt-4 md:mt-0 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-200">
                    Join
                </button>` :
                (isMember ? `<button class="mt-4 md:mt-0 bg-gray-500 text-white font-bold py-2 px-6 rounded-full opacity-70 cursor-not-allowed">
                                Joined
                            </button>` : `<button class="mt-4 md:mt-0 bg-red-500 text-white font-bold py-2 px-6 rounded-full opacity-70 cursor-not-allowed">
                                Full
                            </button>`);

            const leaveButton = isMember && !isHost ?
                `<button onclick="leaveHangout('${hangout.id}')" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-200 ml-4">
                    Leave
                </button>` : '';

            const deleteButton = isHost ?
                `<button onclick="openDeleteConfirmModal('${hangout.id}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-200 ml-4">
                    Delete
                </button>` : '';

            card.innerHTML = `
                <div>
                    <h2 class="text-2xl font-semibold text-gray-800">${hangout.name}</h2>
                    <p class="mt-1 text-gray-600">
                      ${hangout.description}
                    </p>
                    <p class="mt-1 text-sm text-gray-500">
                      Host: <span class="font-semibold">${hangout.hostNickname}</span>
                    </p>
                    <p class="mt-1 text-sm text-gray-500">
                      When: ${hangout.date} at ${hangout.time}
                    </p>
                    <p class="mt-1 text-sm text-gray-500">
                      Where: ${hangout.location}
                    </p>
                    <p class="mt-1 text-sm text-gray-500">
                      Members: ${membersCount} / ${hangout.maxParticipants}
                    </p>
                </div>
                <div class="flex items-center mt-4 md:mt-0">
                    ${joinButton}
                    ${chatButton}
                    ${leaveButton}
                    ${deleteButton}
                </div>
            `;
            return card;
        }

        // --- Firestore Write Operations ---
        createHangoutForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const hangoutName = hangoutNameInput.value.trim();
            const participantCount = parseInt(participantCountInput.value, 10);
            const hangoutDescription = hangoutDescriptionInput.value.trim();
            const hangoutLocation = hangoutLocationInput.value.trim();
            const hangoutDate = hangoutDateInput.value;
            const hangoutTime = hangoutTimeInput.value;
            
            if (!hangoutName || !participantCount || participantCount < 3 || participantCount > 6 || !hangoutLocation || !hangoutDate || !hangoutTime) return;
            
            closeModal('createModal');
            try {
                const newHangoutDoc = doc(collection(db, `artifacts/${firebaseConfig.appId}/public/data/hangouts`));
                await setDoc(newHangoutDoc, {
                    name: hangoutName,
                    description: hangoutDescription,
                    location: hangoutLocation,
                    date: hangoutDate,
                    time: hangoutTime,
                    members: [userId],
                    maxParticipants: participantCount,
                    createdAt: Date.now(),
                    hostId: userId
                });
                createHangoutForm.reset();
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        });
        
        profileForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const nickname = nicknameInput.value.trim();
            if (!nickname) return;
            
            try {
                const profileDocRef = doc(db, `artifacts/${firebaseConfig.appId}/public/data/profiles`, userId);
                await setDoc(profileDocRef, { nickname });
                userNickname = nickname;
                userIdDisplay.textContent = `Welcome, ${userNickname}!`;
                closeModal('profileModal');
            } catch (e) {
                console.error("Error saving profile:", e);
            }
        });
        
        cancelDeleteBtn.onclick = () => {
            closeModal('deleteConfirmModal');
        };

        confirmDeleteBtn.onclick = async () => {
            if (!hangoutToDeleteId) return;
            try {
                await deleteDoc(doc(db, `artifacts/${firebaseConfig.appId}/public/data/hangouts`, hangoutToDeleteId));
                closeModal('deleteConfirmModal');
                hangoutToDeleteId = null;
            } catch (e) {
                console.error("Error deleting document:", e);
                closeModal('deleteConfirmModal');
            }
        };

        window.joinHangout = async function(hangoutId) {
            const hangoutDocRef = doc(db, `artifacts/${firebaseConfig.appId}/public/data/hangouts`, hangoutId);
            try {
                await updateDoc(hangoutDocRef, {
                    members: arrayUnion(userId)
                });
            } catch (e) {
                console.error("Error joining hangout: ", e);
            }
        }

        window.leaveHangout = async function(hangoutId) {
            const hangoutDocRef = doc(db, `artifacts/${firebaseConfig.appId}/public/data/hangouts`, hangoutId);
            try {
                await updateDoc(hangoutDocRef, {
                    members: arrayRemove(userId)
                });
            } catch (e) {
                console.error("Error leaving hangout: ", e);
            }
        }
    </script>
</body>
</html>
